name: Run Pooh Points

on:
  workflow_dispatch:
    inputs:
      date_yyyymmdd:
        description: "Game date (YYYYMMDD). Leave blank for today (Normal only)."
        required: false
        default: ""
      run_mode:
        description: "Normal run uses today if date blank. Final run requires a date and saves Final_* snapshots."
        required: true
        type: choice
        options:
          - normal
          - final
        default: normal

  schedule:
    # Every 10 minutes (cron is UTC on GitHub runners)
    - cron: "*/10 * * * *"

permissions:
  contents: write

# Prevent scheduled/manual runs from stomping each other
concurrency:
  group: pooh-points
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: America/Chicago

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml openpyxl

      - name: Resolve run parameters (Central time "today")
        id: params
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_RUN_MODE: ${{ github.event.inputs.run_mode }}
          INPUT_DATE: ${{ github.event.inputs.date_yyyymmdd }}
        run: |
          set -euo pipefail

          RUN_MODE="normal"
          DATE_INPUT=""

          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            RUN_MODE="${INPUT_RUN_MODE:-normal}"
            DATE_INPUT="${INPUT_DATE:-}"
          fi

          if [[ -z "$DATE_INPUT" ]]; then
            DATE_LOCAL="$(TZ='America/Chicago' date +%Y%m%d)"
          else
            if [[ ! "$DATE_INPUT" =~ ^[0-9]{8}$ ]]; then
              echo "ERROR: date_yyyymmdd must be YYYYMMDD (8 digits). Got: $DATE_INPUT"
              exit 1
            fi
            DATE_LOCAL="$DATE_INPUT"
          fi

          echo "run_mode=$RUN_MODE" >> "$GITHUB_OUTPUT"
          echo "date_yyyymmdd=$DATE_LOCAL" >> "$GITHUB_OUTPUT"

          echo "Event: $EVENT_NAME"
          echo "Run mode: $RUN_MODE"
          echo "Effective date (America/Chicago when blank): $DATE_LOCAL"

      # IMPORTANT:
      # This step expects you to add app/resolve_pd.py (I provided the full file earlier).
      - name: Validate Final Run date maps to a Play Date (PDx)
        if: ${{ steps.params.outputs.run_mode == 'final' }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "ERROR: Final Run is only allowed for manual workflow_dispatch."
            exit 1
          fi
          if [[ "${{ github.event.inputs.date_yyyymmdd || '' }}" == "" ]]; then
            echo "ERROR: Final Run requires you to type a date (YYYYMMDD)."
            exit 1
          fi

          test -f "app/PD.xlsx"
          test -f "app/resolve_pd.py"

          echo "Resolving PD for date ${{ steps.params.outputs.date_yyyymmdd }} ..."
          PD="$(python -u app/resolve_pd.py app/PD.xlsx "${{ steps.params.outputs.date_yyyymmdd }}")"
          echo "Resolved -> $PD"
          echo "$PD" > pd_resolved.txt

      - name: Run Pooh Points script
        shell: bash
        run: |
          set -euo pipefail
          DATE_LOCAL="${{ steps.params.outputs.date_yyyymmdd }}"
          echo "Running script for date $DATE_LOCAL"
          python -u app/python_today_pooh.py "$DATE_LOCAL"

      - name: Build Summary of Results to Date (Final runs only)
        if: ${{ steps.params.outputs.run_mode == 'final' }}
        shell: bash
        run: |
          set -euo pipefail
          python -u app/build_summary_to_date.py

      - name: Build Player Pooh Summary (Final runs only)
        if: ${{ steps.params.outputs.run_mode == 'final' }}
        shell: bash
        run: |
          set -euo pipefail
          python -u app/build_player_pooh_summary.py

      - name: Build Schedule page (HTML)
        shell: bash
        run: |
          set -euo pipefail
          python -u app/build_schedule_html.py

      # Guardrail: if any build step touched Final files, stop.
      # (This is what was corrupting PD7 with PD8 data.)
      - name: Guard: Final_* must not change before snapshot
        if: ${{ steps.params.outputs.run_mode == 'final' }}
        shell: bash
        run: |
          set -euo pipefail
          if git status --porcelain docs/Final_*.html | grep .; then
            echo "ERROR: A build step modified docs/Final_*.html before snapshot copy. Aborting."
            git status --porcelain docs/Final_*.html
            exit 1
          fi

      # Snapshot copy MUST be last so nothing can overwrite it afterwards.
      - name: If Final Run, create Final_* copies for that PD (LAST)
        if: ${{ steps.params.outputs.run_mode == 'final' }}
        shell: bash
        run: |
          set -euo pipefail
          PD="$(cat pd_resolved.txt)"
          echo "Creating Final_* copies for $PD from today_*.html (snapshot written last)"

          test -f "docs/today_players.html"
          test -f "docs/today_owners.html"

          cp -f "docs/today_players.html" "docs/Final_Players_${PD}.html"
          cp -f "docs/today_owners.html"  "docs/Final_Owners_${PD}.html"

          echo "Created:"
          echo "  docs/Final_Players_${PD}.html"
          echo "  docs/Final_Owners_${PD}.html"

      - name: Commit site updates if changed
        shell: bash
        env:
          RUN_MODE: ${{ steps.params.outputs.run_mode }}
          RUN_DATE: ${{ steps.params.outputs.date_yyyymmdd }}
        run: |
          set -euo pipefail

          if [[ -z "$(git status --porcelain docs/)" ]]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "pooh-bot"
          git config user.email "pooh-bot@users.noreply.github.com"
          git add docs/

          MSG="Pooh Points: ${RUN_MODE} ${RUN_DATE}"
          if [[ -f pd_resolved.txt ]]; then
            MSG="${MSG} -> $(cat pd_resolved.txt)"
          fi

          git commit -m "$MSG"
          git pull --rebase origin main
          git push
