name: Run Pooh Points

on:
  workflow_dispatch:
    inputs:
      date_yyyymmdd:
        description: "Game date (YYYYMMDD). Leave blank for today (Normal only)."
        required: false
        default: ""
      run_mode:
        description: "Normal run uses today if date blank. Final run requires a date and saves Final_* snapshots."
        required: true
        type: choice
        options:
          - normal
          - final
        default: normal

  schedule:
    # Every 10 minutes (cron is UTC on GitHub runners)
    - cron: "*/10 * * * *"

permissions:
  contents: write

concurrency:
  group: pooh-points
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: America/Chicago

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml openpyxl

      - name: Resolve run parameters (Central time "today")
        id: params
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_RUN_MODE: ${{ github.event.inputs.run_mode }}
          INPUT_DATE: ${{ github.event.inputs.date_yyyymmdd }}
        run: |
          set -euo pipefail

          RUN_MODE="normal"
          DATE_INPUT=""

          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            RUN_MODE="${INPUT_RUN_MODE:-normal}"
            DATE_INPUT="${INPUT_DATE:-}"
          fi

          if [[ -z "$DATE_INPUT" ]]; then
            DATE_LOCAL="$(TZ='America/Chicago' date +%Y%m%d)"
          else
            if [[ ! "$DATE_INPUT" =~ ^[0-9]{8}$ ]]; then
              echo "ERROR: date_yyyymmdd must be YYYYMMDD (8 digits). Got: $DATE_INPUT"
              exit 1
            fi
            DATE_LOCAL="$DATE_INPUT"
          fi

          echo "run_mode=$RUN_MODE" >> "$GITHUB_OUTPUT"
          echo "date_yyyymmdd=$DATE_LOCAL" >> "$GITHUB_OUTPUT"

          echo "Event: $EVENT_NAME"
          echo "Run mode: $RUN_MODE"
          echo "Effective date (America/Chicago when blank): $DATE_LOCAL"

      - name: Validate Final Run date maps to a Play Date (PDx)
        if: ${{ steps.params.outputs.run_mode == 'final' }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "ERROR: Final Run is only allowed for manual workflow_dispatch."
            exit 1
          fi
          if [[ "${{ github.event.inputs.date_yyyymmdd || '' }}" == "" ]]; then
            echo "ERROR: Final Run requires you to type a date (YYYYMMDD)."
            exit 1
          fi

          if [[ ! -f "app/PD.xlsx" ]]; then
            echo "ERROR: app/PD.xlsx not found. Drop PD.xlsx into the app/ folder."
            exit 1
          fi

          python - <<'PY'
          import re
          from datetime import datetime, date, timedelta
          from openpyxl import load_workbook

          yyyymmdd = "${{ steps.params.outputs.date_yyyymmdd }}".strip()

          if not re.fullmatch(r"\d{8}", yyyymmdd):
              raise SystemExit(f"ERROR: date must be YYYYMMDD (8 digits). Got: {yyyymmdd}")

          yyyy = yyyymmdd[0:4]
          mm   = yyyymmdd[4:6]
          dd   = yyyymmdd[6:8]
          target_mmddyyyy = f"{mm}{dd}{yyyy}"

          wb = load_workbook("app/PD.xlsx", data_only=True)
          ws = wb.active

          def norm_to_mmddyyyy(v):
              if v is None:
                  return None
              if isinstance(v, datetime):
                  return v.strftime("%m%d%Y")
              if isinstance(v, date):
                  return v.strftime("%m%d%Y")
              if isinstance(v, (int, float)):
                  iv = int(v)
                  if 30000 <= iv <= 80000:
                      d = date(1899, 12, 30) + timedelta(days=iv)
                      return d.strftime("%m%d%Y")
                  s = str(iv)
                  return s.zfill(8) if len(s) <= 8 else None

              s = str(v).strip()

              m = re.match(r"^(\d{8})(?:\.0)?$", s)
              if m:
                  return m.group(1)

              m = re.match(r"^(\d{1,2})/(\d{1,2})/(\d{4})$", s)
              if m:
                  mo, da, yr = m.groups()
                  return f"{int(mo):02d}{int(da):02d}{int(yr):04d}"

              m = re.match(r"^(\d{4})-(\d{1,2})-(\d{1,2})$", s)
              if m:
                  yr, mo, da = m.groups()
                  return f"{int(mo):02d}{int(da):02d}{int(yr):04d}"

              m = re.match(r"^(\d{6,8})(?:\.0)?$", s)
              if m:
                  return m.group(1).zfill(8)

              return None

          found = None
          for row in ws.iter_rows(values_only=True):
              if not row or row[0] is None:
                  continue
              left = norm_to_mmddyyyy(row[0])
              if left == target_mmddyyyy:
                  found = row[1]
                  break

          if found is None:
              raise SystemExit(f"ERROR: Date {yyyymmdd} (MMDDYYYY={target_mmddyyyy}) is not in app/PD.xlsx.")

          pdnum = str(found).strip().replace(".0", "")
          if not pdnum.isdigit():
              raise SystemExit(f"ERROR: PD value for {target_mmddyyyy} is not numeric: {found}")

          pd = f"PD{int(pdnum)}"
          print(f"Resolved date {yyyymmdd} -> {target_mmddyyyy} -> {pd}")

          with open("pd_resolved.txt", "w", encoding="utf-8") as f:
              f.write(pd)
          PY

      - name: Run Pooh Points script
        shell: bash
        run: |
          set -euo pipefail
          DATE_LOCAL="${{ steps.params.outputs.date_yyyymmdd }}"
          echo "Running script for date $DATE_LOCAL"
          python -u app/python_today_pooh.py "$DATE_LOCAL"

      - name: Build Summary of Results to Date (Final runs only)
        if: ${{ steps.params.outputs.run_mode == 'final' }}
        shell: bash
        run: |
          set -euo pipefail
          python -u app/build_summary_to_date.py

      - name: Build Player Pooh Summary (Final runs only)
        if: ${{ steps.params.outputs.run_mode == 'final' }}
        shell: bash
        run: |
          set -euo pipefail
          python -u app/build_player_pooh_summary.py

      - name: Build Schedule page (HTML)
        shell: bash
        run: |
          set -euo pipefail
          python -u app/build_schedule_html.py

      - name: Guard: Final_* must not change before snapshot
        if: ${{ steps.params.outputs.run_mode == 'final' }}
        shell: bash
        run: |
          set -euo pipefail
          if git status --porcelain docs/Final_*.html | grep .; then
            echo "ERROR: A build step modified docs/Final_*.html before snapshot copy. Aborting."
            git status --porcelain docs/Final_*.html
            exit 1
          fi

      - name: If Final Run, create Final_* copies for that PD (LAST)
        if: ${{ steps.params.outputs.run_mode == 'final' }}
        shell: bash
        run: |
          set -euo pipefail
          PD="$(cat pd_resolved.txt)"
          echo "Creating Final_* copies for $PD from today_*.html (snapshot written last)"

          test -f "docs/today_players.html"
          test -f "docs/today_owners.html"

          cp -f "docs/today_players.html" "docs/Final_Players_${PD}.html"
          cp -f "docs/today_owners.html"  "docs/Final_Owners_${PD}.html"

          echo "Created:"
          echo "  docs/Final_Players_${PD}.html"
          echo "  docs/Final_Owners_${PD}.html"

      - name: Commit site updates if changed
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "$(git status --porcelain docs/)" ]]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "pooh-bot"
          git config user.email "pooh-bot@users.noreply.github.com"
          git add docs/

          MSG="Pooh Points: ${{ steps.params.outputs.run_mode }} ${{ steps.params.outputs.date_yyyymmdd }}"
          if [[ -f pd_resolved.txt ]]; then
            MSG="$MSG -> $(cat pd_resolved.txt)"
          fi
          git commit -m "$MSG"

          git pull --rebase origin main
          git push
